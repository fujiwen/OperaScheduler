# Opera DataGuard 告警级别设置功能说明

## 功能概述

本功能根据特定的监控指标和条件，自动设置告警级别，提供更精确和有针对性的告警机制。系统会根据数据库运行时间、状态、备份情况和容量使用率等关键指标来判断告警级别。

## 告警级别分类

### 1. 正常 (Normal)
- **标识**: ✅ 正常
- **描述**: 系统运行正常
- **邮件标题格式**: `[✅ 正常] 时间 - Opera DataGuard状态监测报告`

### 2. 警告 (Warning)
- **标识**: 🟡 重要
- **描述**: 发现重要问题，建议尽快处理
- **邮件标题格式**: `[🟡 重要] 时间 - Opera DataGuard状态监测报告`

### 3. 严重 (Critical)
- **标识**: 🔴 紧急
- **描述**: 发现严重问题，需要立即处理
- **邮件标题格式**: `[🔴 紧急] 时间 - Opera DataGuard状态监测报告`

## 告警条件设置

### 1. 服务器运行时间分析

**监控指标**: 数据库运行时间

**告警条件**:
- **少于31天**: 正常 (无告警)
- **32至62天**: `alert-warning` (🟡 重要)
- **63天以上**: `alert-critical` (🔴 紧急)

**告警信息示例**:
- 警告: `数据库运行时间: 45天 - alert-warning (32-62天，需要关注)`
- 严重: `数据库运行时间: 70天 - alert-critical (超过63天，建议立即重启服务器)`

### 2. HTML报告分析

**监控指标**: STATUS状态

**告警条件**:
- **MOUNTED或OPEN**: 正常 (无告警)
- **非MOUNTED或OPEN**: `alert-critical` (🔴 紧急)

**告警信息示例**:
- 严重: `数据库STATUS异常 - alert-critical (STATUS非MOUNTED或OPEN状态)`

### 3. RMAN备份时间检查

**监控指标**: List of last 3 days backups (最后一条数据) 的 END_TIME 与备库信息中的 SYSTEM DATE 对比

**告警条件**:
- **48小时内**: 正常 (无告警)
- **超过48小时**: `alert-critical` (🔴 紧急)

**告警信息示例**:
- 严重: `RMAN备份故障，请立即检查 - alert-critical (备份时间超过48小时)`

### 4. 容量和空间分析

**监控指标**: 整体使用率

**告警条件**:
- **70%以下**: 正常 (无告警)
- **超过70%**: `alert-warning` (🟡 重要)
- **超过80%**: `alert-critical` (🔴 紧急)

**告警信息示例**:
- 警告: `容量使用率: 75.20% - alert-warning (超过70%)`
- 严重: `容量使用率: 85.80% - alert-critical (超过80%)`

## 告警级别优先级

系统采用**最高级别优先**的原则：

1. **alert-critical** > **alert-warning** > **normal**
2. 任何一个条件达到 `alert-critical` 级别，整体告警级别就是 `alert-critical`
3. 如果没有 `alert-critical` 条件，但有 `alert-warning` 条件，整体告警级别为 `alert-warning`
4. 只有所有条件都正常时，整体告警级别才是 `normal`

## 邮件标题格式

新的邮件标题格式为：`[告警级别] 时间 - Opera DataGuard状态监测报告`

**示例**:
- `[✅ 正常] 2025-01-08 14:30 - Opera DataGuard状态监测报告`
- `[🟡 重要] 2025-01-08 14:30 - Opera DataGuard状态监测报告`
- `[🔴 紧急] 2025-01-08 14:30 - Opera DataGuard状态监测报告`

## 技术实现

### 核心方法

1. **`_analyze_alert_levels()`**: 主要的告警级别分析方法
2. **`_check_database_runtime_alert()`**: 检查数据库运行时间告警
3. **`_check_status_alert()`**: 检查STATUS状态告警
4. **`_check_backup_time_alert()`**: 检查RMAN备份时间告警
5. **`_check_capacity_alert()`**: 检查容量使用率告警

### 数据来源

- **HTML报告分析结果**: 从 `analyze_html_report_service_mode()` 方法获取
- **数据库运行时间**: 从HTML报告中的"服务器运行时间分析"部分提取
- **STATUS状态**: 从HTML报告中的数据库信息部分提取
- **备份时间**: 从HTML报告中的"List of last 3 days backups"部分提取
- **容量使用率**: 从HTML报告中的表空间统计信息提取

## 使用场景

### 1. 预防性维护
- 数据库运行时间超过32天时提醒管理员考虑重启
- 容量使用率超过70%时提醒管理员关注空间清理

### 2. 故障快速响应
- 数据库状态异常时立即告警
- 备份故障时立即告警并提示检查

### 3. 运维管理
- 通过邮件标题快速识别问题严重程度
- 支持邮件客户端的自动分类和过滤

## 配置和部署

### 文件更新
- **主程序**: `opera_monitor.py`
- **可执行文件**: `OperaDataGuardTask.exe` (无控制台版本)
- **调试版本**: `OperaDataGuardTask_Console.exe` (带控制台版本)

### 测试验证
- **测试脚本**: `test_alert_levels.py`
- **功能验证**: 包含各种告警条件的测试用例

## 优势特点

1. **智能化告警**: 基于实际业务指标设置告警级别
2. **优先级明确**: 严重问题优先显示，避免重要告警被忽略
3. **邮件识别**: 通过标题快速识别问题严重程度
4. **可扩展性**: 易于添加新的告警条件和指标
5. **向下兼容**: 保持原有功能的同时增强告警机制

## 维护说明

- 告警阈值可根据实际环境需求调整
- 新增告警条件需要在相应的检查方法中实现
- 建议定期检查告警逻辑的有效性
- 可根据运维经验优化告警级别设置

---

**版本**: v2.0  
**更新日期**: 2025-01-08  
**作者**: Opera DataGuard 监控系统